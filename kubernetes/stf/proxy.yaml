apiVersion: v1
kind: ConfigMap
metadata:
  name: squid-config
  namespace: stf
data:
  squid.conf: |
    # Port d'écoute
    http_port 3128

    # ACLs pour autoriser les réseaux locaux
    acl localnet src 10.0.0.0/8
    acl localnet src 172.16.0.0/12
    acl localnet src 192.168.0.0/16
    acl localnet src fc00::/7
    acl localnet src fe80::/10

    # Ports autorisés
    acl SSL_ports port 443
    acl Safe_ports port 80
    acl Safe_ports port 443
    acl Safe_ports port 21
    acl Safe_ports port 1025-65535
    acl CONNECT method CONNECT

    # Règles d'accès
    http_access deny !Safe_ports
    http_access deny CONNECT !SSL_ports
    http_access allow localhost manager
    http_access deny manager
    http_access allow localnet
    http_access allow localhost
    http_access deny all

    # Cache
    coredump_dir /var/cache/squid
    cache_dir ufs /var/cache/squid 100 16 256
    maximum_object_size 20 MB
    cache_mem 256 MB

    # Logs
    access_log /var/log/squid/access.log squid
    cache_log /var/log/squid/cache.log
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: proxy
  namespace: stf
  labels:
    app: proxy
spec:
  replicas: 1
  selector:
    matchLabels:
      app: proxy
  template:
    metadata:
      labels:
        app: proxy
    spec:
      containers:
        - name: squid
          image: ubuntu/squid:latest
          ports:
            - name: proxy
              containerPort: 3128
              protocol: TCP
          volumeMounts:
            - name: config
              mountPath: /etc/squid/squid.conf
              subPath: squid.conf
            - name: cache
              mountPath: /var/cache/squid
            - name: logs
              mountPath: /var/log/squid
          resources:
            requests:
              memory: "256Mi"
              cpu: "100m"
            limits:
              memory: "512Mi"
              cpu: "500m"
          livenessProbe:
            tcpSocket:
              port: 3128
            initialDelaySeconds: 10
            periodSeconds: 10
          readinessProbe:
            tcpSocket:
              port: 3128
            initialDelaySeconds: 5
            periodSeconds: 5
      volumes:
        - name: config
          configMap:
            name: squid-config
        - name: cache
          emptyDir: {}
        - name: logs
          emptyDir: {}
      restartPolicy: Always
---
apiVersion: v1
kind: Service
metadata:
  name: proxy
  namespace: stf
  labels:
    app: proxy
spec:
  type: ClusterIP
  selector:
    app: proxy
  ports:
    - name: proxy
      port: 3128
      targetPort: 3128
      protocol: TCP
