apiVersion: apps/v1
kind: Deployment
metadata:
  name: stf
  namespace: stf
  labels:
    app: stf
spec:
  replicas: 1
  selector:
    matchLabels:
      app: stf
  template:
    metadata:
      labels:
        app: stf
    spec:
      containers:
        - name: stf
          image: stf:arm64
          imagePullPolicy: Never
          env:
            - name: TZ
              value: "Europe/Paris"
            - name: RETHINKDB_PORT_28015_TCP
              value: "tcp://rethinkdb:28015"
            - name: STF_ADMIN_EMAIL
              value: "admin@homelab.local"
            - name: STF_ADMIN_NAME
              value: "Administrator"
          args:
            - stf
            - local
            - --public-ip
            - "stf.freedom35.fr"
            - --app-url
            - "https://stf.freedom35.fr/"
            - --auth-url
            - "https://stf.freedom35.fr/auth/mock/"
            - --websocket-url
            - "wss://stf.freedom35.fr/"
            - --screen-ws-url-pattern
            - "wss://stf.freedom35.fr/screens/${serial}/${publicPort}/"
            - --allow-remote
            - --provider-min-port
            - "7400"
            - --provider-max-port
            - "7500"
            - --adb-host
            - adb
            - --adb-port
            - "5037"
          ports:
            - name: web
              containerPort: 7100
              protocol: TCP
            - name: websocket
              containerPort: 7110
              protocol: TCP
            - name: provider-start
              containerPort: 7400
              protocol: TCP
          volumeMounts:
            - name: usb
              mountPath: /dev/bus/usb
            - name: mock-patch
              mountPath: /app/lib/units/auth/mock.js
              subPath: mock.js
            - name: app-patch
              mountPath: /app/lib/units/app/index.js
              subPath: index.js
            - name: websocket-patch
              mountPath: /app/lib/units/websocket/index.js
              subPath: index.js
            - name: api-patch
              mountPath: /app/lib/units/api/index.js
              subPath: index.js
            - name: poorxy-patch
              mountPath: /app/lib/units/poorxy/index.js
              subPath: index.js
          securityContext:
            privileged: true
          livenessProbe:
            httpGet:
              path: /
              port: 7100
            initialDelaySeconds: 60
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /
              port: 7100
            initialDelaySeconds: 30
            periodSeconds: 5
      volumes:
        - name: usb
          hostPath:
            path: /dev/bus/usb
            type: DirectoryOrCreate
        - name: mock-patch
          configMap:
            name: stf-mock-patch
        - name: app-patch
          configMap:
            name: stf-app-patch
        - name: websocket-patch
          configMap:
            name: stf-websocket-patch
        - name: api-patch
          configMap:
            name: stf-api-patch
        - name: poorxy-patch
          configMap:
            name: stf-poorxy-patch
      nodeName: rpi5
      restartPolicy: Always
